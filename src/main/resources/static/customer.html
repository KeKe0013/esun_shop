<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>電商購物中心｜顧客</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        padding: 24px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 12px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
        vertical-align: middle;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .card {
        border: 1px solid #ddd;
        padding: 16px;
        border-radius: 10px;
        margin-top: 16px;
      }
      .right {
        text-align: right;
      }
      .muted {
        color: #666;
        font-size: 12px;
      }
      .danger {
        color: #b00020;
      }
      .ok {
        color: #0a7f2e;
      }
      button {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: #f7f7f7;
        cursor: pointer;
      }
      button.primary {
        background: #0d6efd;
        color: #fff;
        border-color: #0d6efd;
      }
      input.qty {
        width: 80px;
      }
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .nav-right {
        display: flex;
        gap: 8px;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <nav>
        <div class="nav-right">
          <span class="muted" v-if="currentUser.user">
            登入帳號：{{ currentUser.user }}
          </span>
          <button @click="logout">登出</button>
        </div>
      </nav>

      <h1>電商購物中心（顧客）</h1>

      <!-- 商品清單 -->
      <div class="card">
        <div style="display: flex; align-items: center; gap: 8px">
          <h3 style="margin: 0">商品清單</h3>
          <button @click="loadProducts">重新整理</button>
        </div>

        <table>
          <thead>
            <tr>
              <th></th>
              <th>商品名稱</th>
              <th class="right">售價</th>
              <th class="right">庫存</th>
              <th class="right">購買數量</th>
              <th class="right">小計</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="loadingProducts">
              <td colspan="6">載入中…</td>
            </tr>
            <tr v-else-if="!products.length">
              <td colspan="6">目前無可售商品</td>
            </tr>
            <tr v-for="p in products" :key="p.productId">
              <td>
                <input
                  type="checkbox"
                  :checked="!!cart[p.productId]"
                  @change="onToggleProduct(p, $event)"
                />
              </td>
              <td>{{ p.productName }}</td>
              <td class="right">{{ fmt(p.price) }}</td>
              <td class="right">{{ fmt(p.quantity) }}</td>
              <td class="right">
                <input
                  class="qty"
                  type="number"
                  min="0"
                  :max="p.quantity"
                  step="1"
                  :value="cart[p.productId]?.qty ?? 0"
                  :disabled="!cart[p.productId]"
                  @input="onQtyInput(p, $event)"
                />
              </td>
              <td class="right">
                {{ fmt(rowSubtotal(p)) }}
              </td>
            </tr>
          </tbody>
        </table>

        <div class="muted">
          提示：勾選商品後可輸入購買數量；購買數量不得大於庫存。
        </div>
      </div>

      <!-- 顧客訂單內容 -->
      <div class="card">
        <h3>訂單內容</h3>
        <div class="row">
          <span class="muted">會員編碼：</span>
          <strong>{{ currentUser.userId || "（載入中）" }}</strong>
          <button class="primary" @click="createOrder">建立訂單</button>
        </div>

        <table v-show="orderItems.length">
          <thead>
            <tr>
              <th>商品</th>
              <th class="right">單價</th>
              <th class="right">數量</th>
              <th class="right">小計</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="item in orderItems" :key="item.productId">
              <td>{{ item.productName }}</td>
              <td class="right">{{ fmt(item.price) }}</td>
              <td class="right">{{ fmt(item.qty) }}</td>
              <td class="right">{{ fmt(item.price * item.qty) }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="right"><strong>訂單總金額</strong></td>
              <td class="right">{{ fmt(orderTotal) }}</td>
            </tr>
          </tfoot>
        </table>

        <div :class="msgClass">{{ msg }}</div>
      </div>
    </div>

    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            currentUser: { role: "GUEST", user: "", userId: "" },
            products: [],
            cart: {}, // productId -> { productId, productName, price, stock, qty }
            loadingProducts: false,
            msg: "",
            msgClass: "muted",
          };
        },

        computed: {
          // 購物車中的項目列表
          orderItems() {
            return Object.values(this.cart);
          },
          // 訂單總金額
          orderTotal() {
            return this.orderItems.reduce(
              (sum, item) => sum + item.price * item.qty,
              0
            );
          },
        },

        methods: {
          fmt(n) {
            return Number(n || 0).toLocaleString("zh-TW");
          },

          toast(text, ok = false) {
            this.msg = text;
            this.msgClass = ok ? "ok" : "danger";
            setTimeout(() => {
              this.msg = "";
              this.msgClass = "muted";
            }, 2500);
          },

          async checkAuth() {
            try {
              const res = await fetch("/api/auth/me", {
                credentials: "same-origin",
              });
              const me = await res.json(); // {role, user, userId}
              this.currentUser = me || {
                role: "GUEST",
                user: "",
                userId: "",
              };

              if (this.currentUser.role !== "CUSTOMER") {
                window.location.href = "/login.html";
                return;
              }

              // 身分 OK 再載入商品
              this.loadProducts();
            } catch (e) {
              window.location.href = "/login.html";
            }
          },

          async logout() {
            try {
              await fetch("/api/auth/logout", {
                method: "POST",
                credentials: "same-origin",
              });
            } catch (e) {
              // 忽略錯誤
            }
            window.location.href = "/login.html";
          },

          async loadProducts() {
            this.loadingProducts = true;
            this.products = [];
            this.cart = {};

            try {
              const res = await fetch("/api/products/available", {
                credentials: "same-origin",
              });
              if (!res.ok) throw new Error("讀取商品清單失敗");
              const data = await res.json();
              this.products = Array.isArray(data) ? data : [];
            } catch (err) {
              this.products = [];
              this.toast(err.message || "讀取商品清單失敗");
            } finally {
              this.loadingProducts = false;
            }
          },

          // 勾選 / 取消勾選 商品
          onToggleProduct(p, event) {
            const checked = event.target.checked;
            const id = p.productId;

            if (checked) {
              // 加入購物車，預設數量 1
              this.cart[id] = {
                productId: p.productId,
                productName: p.productName,
                price: p.price,
                stock: p.quantity,
                qty: this.cart[id]?.qty > 0 ? this.cart[id].qty : 1,
              };
              // 若超過庫存，自動壓到庫存上限
              if (this.cart[id].qty > p.quantity) {
                this.cart[id].qty = p.quantity;
              }
            } else {
              // 從購物車移除
              delete this.cart[id];
            }
          },

          // 修改數量
          onQtyInput(p, event) {
            const id = p.productId;
            let val = parseInt(event.target.value || "0", 10);
            if (Number.isNaN(val)) val = 0;
            if (val < 0) val = 0;
            if (val > p.quantity) val = p.quantity;
            event.target.value = val;

            if (val === 0) {
              // 數量 0 視為取消該商品
              delete this.cart[id];
            } else {
              this.cart[id] = {
                productId: p.productId,
                productName: p.productName,
                price: p.price,
                stock: p.quantity,
                qty: val,
              };
            }
          },

          // 每列小計
          rowSubtotal(p) {
            const item = this.cart[p.productId];
            if (!item) return 0;
            return item.price * item.qty;
          },

          async createOrder() {
            const memberId = this.currentUser.userId;
            if (!memberId) {
              this.toast("會員資訊異常，請重新登入");
              return;
            }

            if (!this.orderItems.length) {
              this.toast("請先勾選至少一個商品並設定數量");
              return;
            }

            // 檢查庫存
            for (const item of this.orderItems) {
              if (item.qty > item.stock) {
                this.toast("商品數量超過庫存");
                return;
              }
            }

            const items = this.orderItems.map((x) => ({
              productId: x.productId,
              quantity: x.qty,
              price: x.price,
            }));

            const body = { memberId, items };

            try {
              const res = await fetch("/api/orders", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "same-origin",
                body: JSON.stringify(body),
              });
              if (!res.ok) {
                const txt = await res.text().catch(() => "");
                throw new Error(txt || "建立訂單失敗");
              }
              const orderId = await res.text();
              this.toast(`✅ 建立成功，OrderID: ${orderId}`, true);
              this.cart = {};
              this.loadProducts();
            } catch (err) {
              this.toast("❌ " + (err.message || "建立訂單失敗"));
            }
          },
        },

        mounted() {
          this.checkAuth();
        },
      }).mount("#app");
    </script>
  </body>
</html>
